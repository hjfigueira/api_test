version: "3.8"

services:

    web:
        image: nginx:mainline
        ports:
            - '8080:80'
        volumes:
            - ./src:/var/www/html
            - ./default.conf:/etc/nginx/conf.d/default.conf
        depends_on:
            - php-fpm

    php-fpm:
        build:
            dockerfile: ".docker/Dockerfile_api"
            context: "."
        volumes:
            - ./src:/var/www/html
        depends_on:
            - kafka
            - database

    database:
        image: postgres:12.18-bullseye
        restart: always
        ports:
            - "5432:5432"
        environment:
            POSTGRES_PASSWORD: dev
            POSTGRES_USER: dev
            POSTGRES_DB: api

    kafka:
        image: docker.io/bitnami/kafka:3.6
        ports:
            - "9092:9092"
        environment:
            - KAFKA_CFG_NODE_ID=0
            - KAFKA_CFG_PROCESS_ROLES=controller,broker
            - KAFKA_CFG_CONTROLLER_QUORUM_VOTERS=0@kafka:9093
            - KAFKA_CFG_LISTENERS=PLAINTEXT://:9092,CONTROLLER://:9093
            - KAFKA_CFG_ADVERTISED_LISTENERS=PLAINTEXT://:9092
            - KAFKA_CFG_LISTENER_SECURITY_PROTOCOL_MAP=CONTROLLER:PLAINTEXT,PLAINTEXT:PLAINTEXT
            - KAFKA_CFG_CONTROLLER_LISTENER_NAMES=CONTROLLER
            - KAFKA_CFG_INTER_BROKER_LISTENER_NAME=PLAINTEXT

    worker:
        restart: always
        build:
            dockerfile: ".docker/Dockerfile_worker"
            context: "."
        volumes:
            - ./src:/var/www/html
        depends_on:
            - kafka
            - database
